# name: Azure ML Training

# on:
#   workflow_dispatch:
#   push:
#     paths:
#       - "src/training/**"
#       - "azureml/**"

# jobs:
#   train:
#     runs-on: [self-hosted, windows, mlops]

#     steps:
#       - uses: actions/checkout@v4

#       - name: Submit training job to Azure ML
#         shell: powershell
#         run: |
#           az ml job create `
#             --file azureml/train-job.yml `
#             --resource-group rg-nathan-mpops `
#             --workspace-name mlops-grazvydas

name: Azure ML Training

on:
  workflow_dispatch:
  push:
    paths:
      - "src/training/**"
      - "azureml/**"

jobs:
  train:
    runs-on: [self-hosted, windows, mlops]

    steps:
      - uses: actions/checkout@v4

      - name: Wait for job to complete (poll)
        shell: powershell
        run: |
          $maxMinutes = 60
          $sleepSeconds = 20
          $deadline = (Get-Date).AddMinutes($maxMinutes)

          while ((Get-Date) -lt $deadline) {
            $status = az ml job show `
              --name $env:JOB_NAME `
              --resource-group rg-nathan-mpops `
              --workspace-name mlops-grazvydas `
              --query status -o tsv

            Write-Host "Job $env:JOB_NAME status: $status"

            if ($status -in @("Completed", "Failed", "Canceled")) { break }

            Start-Sleep -Seconds $sleepSeconds
          }

          if (-not $status) { throw "Could not read job status." }
          if ($status -ne "Completed") { throw "Azure ML job finished with status: $status" }

      - name: Wait for job to complete
        shell: powershell
        run: |
          az ml job wait `
            --name $env:JOB_NAME `
            --resource-group rg-nathan-mpops `
            --workspace-name mlops-grazvydas

      - name: Register model from job output
        shell: powershell
        run: |
          $version = "${{ github.run_number }}"

          az ml model create `
            --name fragrance-sentiment-logreg `
            --version $version `
            --path "azureml://jobs/$($env:JOB_NAME)/outputs/model_output/" `
            --type custom_model `
            --resource-group rg-nathan-mpops `
            --workspace-name mlops-grazvydas

          Write-Host "Registered model fragrance-sentiment-logreg:$version"
