name: Azure ML Deploy

on:
  workflow_dispatch:
  push:
    paths:
      - "src/inference/**"
      - "azureml/deployment.yml"
      - "azureml/endpoint.yml"
      - "azureml/conda-infer.yml"

jobs:
  deploy:
    runs-on: [self-hosted, windows, mlops]
    env:
      AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}

    steps:
      - uses: actions/checkout@v4

      - name: Create endpoint (idempotent)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $endpointName = "fragrance-sentiment-endpoint"

          $exists = $null
          try {
            $exists = az ml online-endpoint show `
              --name $endpointName `
              --resource-group rg-nathan-mpops `
              --workspace-name mlops-grazvydas `
              --query name -o tsv 2>$null
          } catch {}

          if (-not $exists) {
            Write-Host "Creating endpoint: $endpointName"
            az ml online-endpoint create `
              --file azureml/endpoint.yml `
              --resource-group rg-nathan-mpops `
              --workspace-name mlops-grazvydas
          } else {
            Write-Host "Endpoint already exists: $endpointName"
          }

      - name: Render deployment.yml with secrets (runtime only)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"

          $src = "azureml/deployment.yml"
          $dst = "azureml/deployment.runtime.yml"

          $content = Get-Content $src -Raw
          $content = $content.Replace("__AZURE_STORAGE_CONNECTION_STRING__", $env:AZURE_STORAGE_CONNECTION_STRING)
          Set-Content -Path $dst -Value $content -Encoding utf8

      - name: Create or update deployment (idempotent)
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          $endpointName = "fragrance-sentiment-endpoint"
          $deploymentName = "blue"

          $depExists = $null
          try {
            $depExists = az ml online-deployment show `
              --name $deploymentName `
              --endpoint-name $endpointName `
              --resource-group rg-nathan-mpops `
              --workspace-name mlops-grazvydas `
              --query name -o tsv 2>$null
          } catch {}

          if (-not $depExists) {
            Write-Host "Creating deployment: $deploymentName"
            az ml online-deployment create `
              --name $deploymentName `
              --endpoint-name $endpointName `
              --file azureml/deployment.runtime.yml `
              --resource-group rg-nathan-mpops `
              --workspace-name mlops-grazvydas
          } else {
            Write-Host "Updating deployment: $deploymentName"
            az ml online-deployment update `
              --name $deploymentName `
              --endpoint-name $endpointName `
              --file azureml/deployment.runtime.yml `
              --resource-group rg-nathan-mpops `
              --workspace-name mlops-grazvydas
          }

      - name: Route 100% traffic to blue
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          az ml online-endpoint update `
            --name fragrance-sentiment-endpoint `
            --resource-group rg-nathan-mpops `
            --workspace-name mlops-grazvydas `
            --traffic blue=100

      - name: Print scoring URI + key
        shell: powershell
        run: |
          $ErrorActionPreference = "Stop"
          az ml online-endpoint show `
            --name fragrance-sentiment-endpoint `
            --resource-group rg-nathan-mpops `
            --workspace-name mlops-grazvydas `
            --query scoring_uri -o tsv

          az ml online-endpoint get-credentials `
            --name fragrance-sentiment-endpoint `
            --resource-group rg-nathan-mpops `
            --workspace-name mlops-grazvydas
